<div class="transactions-page">
  <!-- Toast Messages -->
  <p-toast></p-toast>

  <!-- Hero Section -->
  <div class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">Lịch sử giao dịch</h1>
      <p class="hero-subtitle">Xem và quản lý tất cả giao dịch của bạn</p>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper">
    <div class="transactions-container">
      <!-- Filters Card -->
      <div class="filters-card">
        <form
          [formGroup]="filterForm"
          (ngSubmit)="applyFilters()"
          class="filters-form"
        >
          <div class="filters-grid">
            <div class="filter-group">
              <label class="filter-label">Loại giao dịch</label>
              <select formControlName="type" class="filter-select">
                <option value="">Tất cả</option>
                <option [value]="TransactionType.DEPOSIT">Nạp tiền</option>
                <option [value]="TransactionType.WITHDRAW">Rút tiền</option>
                <option [value]="TransactionType.TRANSFER_SEND">
                  Chuyển khoản
                </option>
                <option [value]="TransactionType.TRANSFER_RECEIVE">
                  Nhận tiền
                </option>
              </select>
            </div>

            <div class="filter-group">
              <label class="filter-label">Từ ngày</label>
              <input
                type="date"
                formControlName="from"
                class="filter-date"
                (click)="openDatePicker($event)"
              />
            </div>

            <div class="filter-group">
              <label class="filter-label">Đến ngày</label>
              <input
                type="date"
                formControlName="to"
                class="filter-date"
                (click)="openDatePicker($event)"
              />
            </div>

            <div class="filter-group">
              <label class="filter-label">Số tiền tối thiểu</label>
              <input
                type="number"
                formControlName="min"
                placeholder="0"
                class="filter-input"
                min="0"
                step="1000"
              />
            </div>

            <div class="filter-group">
              <label class="filter-label">Số tiền tối đa</label>
              <input
                type="number"
                formControlName="max"
                placeholder="Không giới hạn"
                class="filter-input"
                min="0"
                step="1000"
              />
            </div>
          </div>

          <div class="filter-actions">
            <p-button
              type="submit"
              label="Lọc"
              icon="pi pi-filter"
              class="filter-btn primary"
            >
            </p-button>
            <p-button
              type="button"
              label="Xóa bộ lọc"
              icon="pi pi-times"
              class="filter-btn secondary"
              (click)="clearFilters()"
            >
            </p-button>
            <p-button
              type="button"
              label="Xuất CSV"
              icon="pi pi-download"
              class="filter-btn success"
              (click)="exportCsv()"
              [loading]="isExporting"
            >
            </p-button>
          </div>
        </form>
      </div>

      <!-- Transactions Table Card -->
      <div class="transactions-card">
        <div class="card-header">
          <div class="header-icon">
            <i class="pi pi-history"></i>
          </div>
          <div class="header-content">
            <h3 class="header-title">Lịch sử giao dịch</h3>
            <p class="header-subtitle">Tất cả giao dịch của bạn</p>
          </div>
        </div>

        <div class="transactions-content">
          @if (isLoading) {
            <div class="loading-container">
              <p-progressSpinner
                [style]="{ width: '50px', height: '50px' }"
              ></p-progressSpinner>
            </div>
          } @else {
            <div class="transactions-table">
              <div class="table-header">
                <div class="header-cell sortable" (click)="sortBy('type')">
                  Loại
                  @if (sortField !== "type") {
                    <i class="pi pi-sort-alt"></i>
                  }
                  @if (sortField === "type" && sortOrder === 1) {
                    <i class="pi pi-sort-up"></i>
                  }
                  @if (sortField === "type" && sortOrder === -1) {
                    <i class="pi pi-sort-down"></i>
                  }
                </div>
                <div class="header-cell sortable" (click)="sortBy('amount')">
                  Số tiền
                  @if (sortField !== "amount") {
                    <i class="pi pi-sort-alt"></i>
                  }
                  @if (sortField === "amount" && sortOrder === 1) {
                    <i class="pi pi-sort-up"></i>
                  }
                  @if (sortField === "amount" && sortOrder === -1) {
                    <i class="pi pi-sort-down"></i>
                  }
                </div>
                <div class="header-cell sortable" (click)="sortBy('status')">
                  Trạng thái
                  @if (sortField !== "status") {
                    <i class="pi pi-sort-alt"></i>
                  }
                  @if (sortField === "status" && sortOrder === 1) {
                    <i class="pi pi-sort-up"></i>
                  }
                  @if (sortField === "status" && sortOrder === -1) {
                    <i class="pi pi-sort-down"></i>
                  }
                </div>
                <div class="header-cell sortable" (click)="sortBy('createdAt')">
                  Thời gian
                  @if (sortField !== "createdAt") {
                    <i class="pi pi-sort-alt"></i>
                  }
                  @if (sortField === "createdAt" && sortOrder === 1) {
                    <i class="pi pi-sort-up"></i>
                  }
                  @if (sortField === "createdAt" && sortOrder === -1) {
                    <i class="pi pi-sort-down"></i>
                  }
                </div>
                <div class="header-cell">Mô tả</div>
              </div>

              <div class="table-body">
                @for (transaction of transactions; track transaction._id) {
                  <div class="table-row">
                    <div class="table-cell">
                      <div class="transaction-type">
                        <i
                          [class]="
                            getTransactionIcon(transaction.transType) +
                            ' ' +
                            getTransactionColor(transaction.transType)
                          "
                        ></i>
                        <span class="capitalize">{{
                          getTransactionTypeLabel(transaction.transType)
                        }}</span>
                      </div>
                    </div>
                    <div class="table-cell">
                      <span [class]="getAmountClass(transaction.transType)">
                        {{ getAmountPrefix(transaction.transType)
                        }}{{ transaction.transMoney | currencyVnd }}
                      </span>
                    </div>
                    <div class="table-cell">
                      <div class="status-badge completed">Hoàn thành</div>
                    </div>
                    <div class="table-cell">
                      {{ transaction.createdAt | date: "dd/MM/yyyy HH:mm" }}
                    </div>
                    <div class="table-cell">
                      <span>{{ getTransactionDescription(transaction) }}</span>
                    </div>
                  </div>
                }

                @if (transactions.length === 0) {
                  <div class="empty-state">
                    <div class="empty-content">
                      <i class="pi pi-inbox empty-icon"></i>
                      <p class="empty-text">Không tìm thấy giao dịch nào</p>
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- Pagination -->
            @if (totalRecords > pageSize) {
              <div class="pagination-container">
                <div class="pagination-info">
                  Hiển thị {{ (currentPage - 1) * pageSize + 1 }} -
                  {{ Math.min(currentPage * pageSize, totalRecords) }}
                  trong {{ totalRecords }} giao dịch
                </div>
                <div class="pagination-controls">
                  <button
                    class="pagination-btn"
                    (click)="goToPage(1)"
                    [disabled]="currentPage === 1"
                  >
                    <i class="pi pi-angle-double-left"></i>
                  </button>
                  <button
                    class="pagination-btn"
                    (click)="goToPage(currentPage - 1)"
                    [disabled]="currentPage === 1"
                  >
                    <i class="pi pi-angle-left"></i>
                  </button>
                  <span class="pagination-info">
                    Trang {{ currentPage }} / {{ totalPages }}
                  </span>
                  <button
                    class="pagination-btn"
                    (click)="goToPage(currentPage + 1)"
                    [disabled]="currentPage === totalPages"
                  >
                    <i class="pi pi-angle-right"></i>
                  </button>
                  <button
                    class="pagination-btn"
                    (click)="goToPage(totalPages)"
                    [disabled]="currentPage === totalPages"
                  >
                    <i class="pi pi-angle-double-right"></i>
                  </button>
                </div>
              </div>
            }
          }
        </div>
      </div>
    </div>
  </div>
</div>
