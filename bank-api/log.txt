# LOG TRAO ƒê·ªîI - D·ª∞ √ÅN NESTJS BANKING API

## T·ªîNG QUAN D·ª∞ √ÅN
D·ª± √°n "banking-be" - NestJS Banking API v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng:
- NestJS 10, Node 20, Yarn
- MongoDB v·ªõi Mongoose
- JWT Authentication (15 ph√∫t)
- Email Verification (6 ch·ªØ s·ªë, 15 ph√∫t)
- RBAC: user/admin/superadmin
- Transaction limits: 20M/l·∫ßn, 500M/ng√†y
- Idempotency support
- Swagger documentation
- Docker & Docker Compose
- Comprehensive testing

## C·∫§U TR√öC D·ª∞ √ÅN

### 1. Tech Stack & Dependencies
- **Core**: NestJS 10, Node 20, Yarn
- **Database**: MongoDB, Mongoose, Decimal128
- **Authentication**: JWT, Passport.js, bcrypt
- **Email**: Nodemailer v·ªõi MailHog (dev)
- **Validation**: class-validator, class-transformer
- **Documentation**: Swagger/OpenAPI
- **Logging**: @nestjs/pino
- **Testing**: Jest, supertest
- **Docker**: Multi-stage build, Docker Compose

### 2. C·∫•u tr√∫c th∆∞ m·ª•c
```
src/
‚îú‚îÄ‚îÄ main.ts
‚îú‚îÄ‚îÄ app.module.ts
‚îú‚îÄ‚îÄ config/           # C·∫•u h√¨nh ·ª©ng d·ª•ng
‚îú‚îÄ‚îÄ common/           # Shared utilities
‚îÇ   ‚îú‚îÄ‚îÄ guards/       # JWT, Roles guards
‚îÇ   ‚îú‚îÄ‚îÄ decorators/   # Custom decorators
‚îÇ   ‚îú‚îÄ‚îÄ filters/      # Exception filters
‚îÇ   ‚îú‚îÄ‚îÄ interceptors/ # Transform interceptors
‚îÇ   ‚îú‚îÄ‚îÄ pipes/        # Validation pipes
‚îÇ   ‚îî‚îÄ‚îÄ dto/          # Common DTOs
‚îú‚îÄ‚îÄ database/         # MongoDB schemas
‚îú‚îÄ‚îÄ modules/          # Feature modules
‚îÇ   ‚îú‚îÄ‚îÄ auth/         # Authentication
‚îÇ   ‚îú‚îÄ‚îÄ accounts/     # User profiles
‚îÇ   ‚îú‚îÄ‚îÄ transactions/ # Money operations
‚îÇ   ‚îú‚îÄ‚îÄ admin/        # Admin panel
‚îÇ   ‚îú‚îÄ‚îÄ health/       # Health checks
‚îÇ   ‚îú‚îÄ‚îÄ email/        # Email service
‚îÇ   ‚îú‚îÄ‚îÄ audit/        # Audit logging
‚îÇ   ‚îî‚îÄ‚îÄ wallet/       # Wallet queries
‚îî‚îÄ‚îÄ seed/             # Database seeders

docs/                 # Documentation
.cursor/rules/        # Cursor AI rules
test/                 # E2E tests
scripts/              # Utility scripts
```

## C√ÅC MODULE CH√çNH

### 1. Authentication Module
**Endpoints:**
- `POST /auth/register` - ƒêƒÉng k√Ω t√†i kho·∫£n
- `POST /auth/verify` - X√°c minh email
- `POST /auth/resend-verification` - G·ª≠i l·∫°i m√£ x√°c minh
- `POST /auth/login` - ƒêƒÉng nh·∫≠p
- `POST /auth/change-password` - ƒê·ªïi m·∫≠t kh·∫©u

**T√≠nh nƒÉng:**
- Email verification v·ªõi m√£ 6 ch·ªØ s·ªë (15 ph√∫t)
- JWT token (15 ph√∫t expiration)
- Rate limiting: 5 req/10min cho auth endpoints
- Password complexity validation
- Bcrypt hashing v·ªõi salt rounds >= 12

### 2. Accounts Module
**Endpoints:**
- `GET /profile` - L·∫•y th√¥ng tin profile
- `PATCH /profile` - C·∫≠p nh·∫≠t profile
- `GET /balance` - L·∫•y s·ªë d∆∞ t√†i kho·∫£n

**T√≠nh nƒÉng:**
- Profile management
- Balance checking
- Audit logging cho profile updates

### 3. Transactions Module
**Endpoints:**
- `GET /wallet/can-withdraw` - Ki·ªÉm tra c√≥ th·ªÉ r√∫t ti·ªÅn
- `POST /transactions/deposit` - N·∫°p ti·ªÅn
- `POST /transactions/withdraw` - R√∫t ti·ªÅn
- `GET /transactions` - L·ªãch s·ª≠ giao d·ªãch
- `GET /transactions/export.csv` - Xu·∫•t CSV

**T√≠nh nƒÉng:**
- Deposit/withdraw v·ªõi MongoDB transactions
- Per-transaction limit: 20,000,000 VND
- Daily limit: 500,000,000 VND (VN timezone)
- Idempotency support v·ªõi clientRequestId
- CSV export v·ªõi injection protection
- Balance validation v√† concurrency control

### 4. Admin Module
**Endpoints:**
- `GET /admin/users` - Danh s√°ch users (Admin/Superadmin)
- `PATCH /admin/users/:id` - C·∫≠p nh·∫≠t user (Superadmin only)
- `POST /admin/users/:id/resend-verification` - G·ª≠i l·∫°i m√£ x√°c minh
- `GET /admin/transactions` - T·∫•t c·∫£ giao d·ªãch

**T√≠nh nƒÉng:**
- RBAC v·ªõi 3 roles: user/admin/superadmin
- User management v·ªõi search/filter
- Transaction monitoring
- Self-demotion protection
- Comprehensive audit logging

### 5. Health Module
**Endpoints:**
- `GET /health` - Health check

**T√≠nh nƒÉng:**
- Database connection status
- Application version
- Timestamp

## DATABASE SCHEMAS

### 1. Account Schema
```typescript
{
  name: string (required)
  email: string (required, unique, lowercase)
  phone?: string (unique, sparse)
  passwordHash: string (required)
  role: 'user' | 'admin' | 'superadmin' (default: 'user')
  status: 'active' | 'locked' (default: 'active')
  balance: Decimal128 (default: 0)
  isEmailVerified: boolean (default: false)
  verifiedAt?: Date
  createdAt: Date
  updatedAt: Date
}
```

### 2. EmailVerification Schema
```typescript
{
  accountId: ObjectId (ref: Account, required)
  code: string (required, unique)
  expiresAt: Date (required)
  usedAt?: Date
  createdAt: Date
}
```

### 3. Transaction Schema
```typescript
{
  accountId: ObjectId (ref: Account, required)
  transName: string (required)
  transMoney: Decimal128 (required, > 0)
  transType: 1 | 2 (1=deposit, 2=withdraw)
  clientRequestId?: string (unique, sparse)
  createdAt: Date
}
```

### 4. AuditLog Schema
```typescript
{
  actorId?: ObjectId (ref: Account)
  action: string (required)
  resource: string (required)
  meta: any
  createdAt: Date
}
```

## CONFIGURATION

### 1. Environment Variables (.env.sample)
```
MONGODB_URI=mongodb://mongo:27017/banking
JWT_SECRET=change-me
APP_BASE_URL=http://localhost:4200
EMAIL_HOST=mailhog
EMAIL_PORT=1025
EMAIL_USER=
EMAIL_PASS=
TZ=Asia/Ho_Chi_Minh
SEED_SUPERADMIN_EMAIL=superadmin@example.com
SEED_SUPERADMIN_PASSWORD=ChangeMe123!
```

### 2. Docker Configuration
- **Dockerfile**: Multi-stage build (node:20-alpine)
- **docker-compose.yml**: mongo, mailhog, api services
- **Ports**: API:3000, Mongo:27017, MailHog:1025/8025

### 3. Swagger Documentation
- **UI**: http://localhost:3000/docs
- **JSON**: http://localhost:3000/docs-json
- Bearer authentication globally configured
- Comprehensive API documentation v·ªõi examples

## SECURITY FEATURES

### 1. Authentication & Authorization
- JWT tokens v·ªõi 15 ph√∫t expiration
- RBAC v·ªõi 3 roles v√† proper guards
- Password complexity requirements
- Rate limiting cho auth endpoints

### 2. Transaction Security
- MongoDB transactions cho atomicity
- Balance validation tr∆∞·ªõc khi withdraw
- Daily limits v·ªõi VN timezone
- Idempotency support
- Concurrency control

### 3. Input Validation
- class-validator cho t·∫•t c·∫£ inputs
- Email format validation
- Vietnamese phone number validation
- Amount validation (> 0)
- CSV injection protection

### 4. Audit & Monitoring
- Comprehensive audit logging
- Structured logging v·ªõi Pino
- Health checks
- Error tracking

## TESTING

### 1. Unit Tests
- AuthService tests
- TransactionsService tests
- RolesGuard tests
- Mocking strategies

### 2. Integration Tests
- Complete user flows
- Concurrency testing
- Admin operations
- Database interactions

### 3. E2E Tests
- Full API workflows
- Authentication flows
- Transaction scenarios
- Admin access control

## CURSOR RULES

### 1. api-standards.mdc
Chu·∫©n API: DTO+Validation, Swagger, ph√¢n trang, Decimal128, m√£ l·ªói chu·∫©n

### 2. auth-and-email.mdc
Auth + Verify Email + JWT 15m + Resend + Change Password

### 3. transactions-and-limits.mdc
N·∫°p/R√∫t an to√†n, transaction Mongo, limit 20M/l·∫ßn & 500M/ng√†y, can-withdraw, idempotency

### 4. rbac-and-admin.mdc
RBAC user|admin|superadmin, Admin APIs, Audit

### 5. testing-and-quality.mdc
B·∫Øt bu·ªôc test nghi·ªáp v·ª• ti·ªÅn v√† b·∫£o m·∫≠t; Throttler; Logger

### 6. chore-docs-and-swagger.mdc
Lu√¥n c·∫≠p nh·∫≠t Swagger + docs/FEATURES.md khi thay ƒë·ªïi API

## YARN SCRIPTS

### Development
- `yarn start:dev` - Development server
- `yarn build` - Build application
- `yarn start:prod` - Production server

### Testing
- `yarn test` - Unit tests
- `yarn test:e2e` - E2E tests

### Docker
- `yarn docker:up` - Start all services
- `yarn docker:down` - Stop all services
- `yarn docker:logs` - View API logs

### Utilities
- `yarn seed:superadmin` - Create superadmin user
- `yarn lint` - ESLint check
- `yarn lint:fix` - ESLint fix

## ERROR CODES

### Authentication Errors
- `EMAIL_EXISTS`: Email ƒë√£ t·ªìn t·∫°i v√† verified
- `EMAIL_NOT_VERIFIED`: Email ch∆∞a ƒë∆∞·ª£c x√°c minh
- `INVALID_CODE`: M√£ x√°c minh kh√¥ng h·ª£p l·ªá
- `CODE_EXPIRED`: M√£ x√°c minh ƒë√£ h·∫øt h·∫°n
- `INVALID_CREDENTIALS`: Email/password kh√¥ng ƒë√∫ng
- `FORBIDDEN`: T√†i kho·∫£n b·ªã kh√≥a

### Transaction Errors
- `INSUFFICIENT_FUNDS`: S·ªë d∆∞ kh√¥ng ƒë·ªß
- `LIMIT_PER_TRANSACTION`: V∆∞·ª£t gi·ªõi h·∫°n m·ªói giao d·ªãch
- `DAILY_LIMIT_EXCEEDED`: V∆∞·ª£t gi·ªõi h·∫°n h√†ng ng√†y
- `IDEMPOTENT_REPLAY`: Giao d·ªãch tr√πng l·∫∑p

### Authorization Errors
- `UNAUTHORIZED`: Token kh√¥ng h·ª£p l·ªá
- `FORBIDDEN`: Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p

## RESPONSE FORMAT

### Success Response
```typescript
{
  success: true,
  data: any,
  message?: string
}
```

### Error Response
```typescript
{
  success: false,
  code: string,
  message: string,
  details?: any
}
```

## FEATURES IMPLEMENTED

### ‚úÖ Core Features
- [x] User registration v·ªõi email verification
- [x] JWT authentication (15 ph√∫t)
- [x] RBAC v·ªõi 3 roles
- [x] Profile management
- [x] Transaction system (deposit/withdraw)
- [x] Transaction limits (20M/l·∫ßn, 500M/ng√†y)
- [x] Idempotency support
- [x] CSV export
- [x] Admin panel
- [x] Health checks
- [x] Audit logging

### ‚úÖ Technical Features
- [x] Docker & Docker Compose
- [x] Swagger documentation
- [x] Comprehensive testing
- [x] Structured logging
- [x] Input validation
- [x] Error handling
- [x] Rate limiting
- [x] CORS configuration
- [x] Database indexes
- [x] Superadmin seeder

### ‚úÖ Security Features
- [x] Password hashing v·ªõi bcrypt
- [x] JWT token security
- [x] Rate limiting
- [x] Input sanitization
- [x] CSV injection protection
- [x] Audit trail
- [x] Role-based access control

## QUICK START

### 1. Setup
```bash
# Clone v√† c√†i ƒë·∫∑t dependencies
yarn install

# C·∫•u h√¨nh environment
cp .env.sample .env

# Ch·∫°y v·ªõi Docker
yarn docker:up

# Seed superadmin
yarn seed:superadmin
```

### 2. Access Points
- **API**: http://localhost:3000
- **Swagger**: http://localhost:3000/docs
- **Health**: http://localhost:3000/health
- **MailHog**: http://localhost:8025

### 3. Testing
```bash
# Unit tests
yarn test

# E2E tests
yarn test:e2e

# Build
yarn build
```

## PROJECT STATUS

### ‚úÖ Completed
- T·∫•t c·∫£ core features ƒë√£ ƒë∆∞·ª£c implement
- Database schemas v√† relationships
- Authentication & authorization
- Transaction system v·ªõi limits
- Admin panel v·ªõi RBAC
- Comprehensive testing
- Docker setup
- Swagger documentation
- Cursor rules
- Documentation

### üéØ Ready for Use
D·ª± √°n ƒë√£ s·∫µn s√†ng ƒë·ªÉ:
- Development v√† testing
- Production deployment
- API integration
- User management
- Transaction processing

## TECHNICAL HIGHLIGHTS

### 1. Architecture
- Modular NestJS architecture
- Clean separation of concerns
- Scalable design patterns
- Comprehensive error handling

### 2. Security
- Multi-layer security approach
- Proper authentication/authorization
- Input validation v√† sanitization
- Audit logging

### 3. Performance
- Database indexing
- Efficient queries
- Connection pooling
- Optimized aggregations

### 4. Maintainability
- Comprehensive documentation
- Cursor AI rules
- Consistent code style
- Extensive testing

### 5. Developer Experience
- Hot reload development
- Comprehensive Swagger docs
- Docker development environment
- Clear project structure

---

**D·ª± √°n ƒë√£ ho√†n th√†nh ƒë·∫ßy ƒë·ªß theo y√™u c·∫ßu ban ƒë·∫ßu v√† s·∫µn s√†ng ƒë·ªÉ s·ª≠ d·ª•ng!**
